<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .health-bar {
      background: linear-gradient(to right, #dc2626, #b91c1c, #dc2626);
      height: 100%;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: width 0.2s ease-in-out;
    }
    .character-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border: 2px solid #facc15;
      border-radius: 8px;
      transition: border-color 0.2s ease-in-out;
      cursor: pointer;
      padding: 0.5rem;
    }
    .character-container.selected {
      border-color: #facc15;
    }
    .character-container:not(.selected) {
      border-color: rgba(250, 204, 21, 0);
    }
    .portrait {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      object-position: center top;
      border: 3px solid #4b5563;
      display: block;
      transition: opacity 0.2s ease-in-out, filter 0.2s ease-in-out;
    }
    .portrait[src=""], .portrait:not([src]) {
      visibility: hidden;
    }
    #character-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      height: 100vh;
      width: 100vw;
      padding: 1rem;
      box-sizing: border-box;
    }
    .column {
      display: contents;
    }
    .hp-change {
      margin-left: 0.5rem;
      color: white;
      font-size: 1rem;
      font-weight: bold;
      animation: bounce 0.4s ease-in-out;
    }
    .unconscious .portrait {
      opacity: 0.7;
      filter: saturate(0.3);
    }
    .unconscious .name {
      text-decoration: line-through;
      opacity: 0.7;
    }
    .dead .name, .dead .hp-text, .dead .portrait {
      opacity: 0.5;
    }
    .dead .name {
      text-decoration: line-through;
      position: relative;
    }
    .dead .name::before,
    .dead .name::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: #dc2626;
      left: 0;
      top: 50%;
    }
    .dead .name::before {
      transform: rotate(45deg);
    }
    .dead .name::after {
      transform: rotate(-45deg);
    }
    .dead .portrait {
      filter: grayscale(100%);
      position: relative;
    }
    .stabilized .portrait {
      opacity: 0.7;
      filter: saturate(0.5) brightness(0.7);
    }
    .stabilized .name, .stabilized .hp-text {
      opacity: 0.8;
    }
    .portrait-wrapper {
      position: relative;
      display: inline-block;
    }
    .skull-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      z-index: 10;
      pointer-events: none;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
    }
    .wild-shape-btn {
      margin-left: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: #10b981;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .wild-shape-btn:hover {
      background: #059669;
    }
    .wild-shape-btn.active {
      background: #f59e0b;
    }
    .wild-shape-btn:disabled {
      background: #6b7280;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .wild-shape-bar {
      background: linear-gradient(to right, #10b981, #059669, #10b981);
    }
    @keyframes bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.5); }
      100% { transform: scale(1); }
    }
    @media (max-height: 600px) {
      .character-container {
        min-height: 48px;
      }
      .text-lg {
        font-size: 0.9rem;
      }
      .text-sm {
        font-size: 0.7rem;
      }
      .h-5 {
        height: 0.75rem;
      }
      .column {
        gap: 0.375rem;
      }
      .hp-change {
        font-size: 0.8rem;
      }
    }
    @media (max-height: 400px) {
      .character-container {
        min-height: 36px;
      }
      .text-lg {
        font-size: 0.75rem;
      }
      .text-sm {
        font-size: 0.6rem;
      }
      .h-5 {
        height: 0.5rem;
      }
      .column {
        gap: 0.125rem;
      }
      .hp-change {
        font-size: 0.7rem;
      }
    }
    @media (max-height: 300px) {
      .character-container {
        min-height: 28px;
      }
      .text-lg {
        font-size: 0.65rem;
      }
      .text-sm {
        font-size: 0.5rem;
      }
      .h-5 {
        height: 0.4rem;
      }
      .column {
        gap: 0.125rem;
      }
      .hp-change {
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div id="character-list">
      <div class="column">
        <!-- Zendith -->
        <div class="character-container p-2" id="char-0">
          <div class="portrait-wrapper">
            <img src="Portrait/Zendith.PNG" alt="" class="portrait">
            <div class="skull-overlay" id="skull-0" style="display: none;">ðŸ’€</div>
          </div>
          <div class="flex-1">
            <div class="flex items-center">
              <div class="text-lg font-semibold name">Zendith</div>
              <div class="hp-change" id="hp-change-0"></div>
            </div>
            <div class="w-full bg-gray-700 rounded h-5">
              <div class="health-bar" id="health-0"></div>
            </div>
            <div class="text-sm text-gray-300 hp-text" id="hp-0"></div>
          </div>
        </div>
        <!-- Feathers -->
        <div class="character-container p-2" id="char-2">
          <div class="portrait-wrapper">
            <img src="Portrait/Feathers.png" alt="" class="portrait">
            <div class="skull-overlay" id="skull-2" style="display: none;">ðŸ’€</div>
          </div>
          <div class="flex-1">
            <div class="flex items-center">
              <div class="text-lg font-semibold name">Feathers</div>
              <div class="hp-change" id="hp-change-2"></div>
            </div>
            <div class="w-full bg-gray-700 rounded h-5">
              <div class="health-bar" id="health-2"></div>
            </div>
            <div class="text-sm text-gray-300 hp-text" id="hp-2"></div>
          </div>
        </div>
        <!-- Batula -->
        <div class="character-container p-2" id="char-4">
          <div class="portrait-wrapper">
            <img src="Portrait/Batula.png" alt="" class="portrait">
            <div class="skull-overlay" id="skull-4" style="display: none;">ðŸ’€</div>
          </div>
          <div class="flex-1">
            <div class="flex items-center">
              <div class="text-lg font-semibold name">Batula</div>
              <button class="wild-shape-btn" id="wild-shape-btn" onclick="toggleWildShape()">Wild Shape</button>
              <div class="hp-change" id="hp-change-4"></div>
            </div>
            <div id="wild-shape-bar-wrapper" style="display: none;">
              <div class="w-full bg-gray-700 rounded h-5" style="margin-bottom: 0.25rem;">
                <div class="health-bar wild-shape-bar" id="health-4-wild"></div>
              </div>
              <div class="text-sm text-gray-300 hp-text" id="hp-4-wild"></div>
            </div>
            <div class="w-full bg-gray-700 rounded h-5">
              <div class="health-bar" id="health-4"></div>
            </div>
            <div class="text-sm text-gray-300 hp-text" id="hp-4"></div>
          </div>
        </div>
      </div>
      <div class="column">
        <!-- Terra -->
        <div class="character-container p-2" id="char-1">
          <div class="portrait-wrapper">
            <img src="Portrait/Terra.png" alt="" class="portrait">
            <div class="skull-overlay" id="skull-1" style="display: none;">ðŸ’€</div>
          </div>
          <div class="flex-1">
            <div class="flex items-center">
              <div class="text-lg font-semibold name">Terra</div>
              <div class="hp-change" id="hp-change-1"></div>
            </div>
            <div class="w-full bg-gray-700 rounded h-5">
              <div class="health-bar" id="health-1"></div>
            </div>
            <div class="text-sm text-gray-300 hp-text" id="hp-1"></div>
          </div>
        </div>
        <!-- Immeral -->
        <div class="character-container p-2" id="char-3">
          <img src="Portrait/Immeral.png" alt="" class="portrait">
          <div class="flex-1">
            <div class="flex items-center">
              <div class="text-lg font-semibold name">Immeral</div>
              <div class="hp-change" id="hp-change-3"></div>
            </div>
            <div class="w-full bg-gray-700 rounded h-5">
              <div class="health-bar" id="health-3"></div>
            </div>
            <div class="text-sm text-gray-300 hp-text" id="hp-3"></div>
          </div>
        </div>
      </div>
    </div>

  <script>
    const characters = [
      { name: "Zendith", maxHP: 20, currentHP: 20, negativeMaxHP: 20, changeCounter: 0, changeTimeout: null, isStabilized: false },
      { name: "Terra", maxHP: 18, currentHP: 18, negativeMaxHP: 18, changeCounter: 0, changeTimeout: null, isStabilized: false },
      { name: "Feathers", maxHP: 28, currentHP: 28, negativeMaxHP: 28, changeCounter: 0, changeTimeout: null, isStabilized: false },
      { name: "Immeral", maxHP: 23, currentHP: 23, negativeMaxHP: 23, changeCounter: 0, changeTimeout: null, isStabilized: false },
      { name: "Batula", maxHP: 21, currentHP: 21, negativeMaxHP: 21, changeCounter: 0, changeTimeout: null, wildShapeMaxHP: 0, wildShapeCurrentHP: 0, isWildShaped: false, wildShapeUsesRemaining: 1, isStabilized: false }
    ];

    const navOrder = [0, 2, 4, 1, 3]; // Navigation order: Zendith(0), Feathers(2), Batula(4), Terra(1), Immeral(3)
    let selectedNavIndex = -1; // Tracks position in navOrder

    function renderCharacters() {
      characters.forEach((char, index) => {
        const percentage = (char.currentHP / char.maxHP) * 100;
        const charElement = document.getElementById(`char-${index}`);
        const healthElement = document.getElementById(`health-${index}`);
        const hpElement = document.getElementById(`hp-${index}`);
        const nameElement = charElement.querySelector('.name');
        const portraitElement = charElement.querySelector('.portrait');
        const skullElement = document.getElementById(`skull-${index}`);
        
        // Determine character state
        const isDead = char.currentHP <= -char.negativeMaxHP;
        const isUnconscious = char.currentHP <= 0 && !isDead;
        
        // Update classes
        charElement.className = `character-container p-2 ${navOrder[selectedNavIndex] === index ? "selected" : ""} ${isDead ? "dead" : ""} ${isUnconscious ? "unconscious" : ""} ${char.isStabilized ? "stabilized" : ""}`;
        
        // Update health bar and text
        if (char.currentHP <= 0 && !isDead) {
          // HP at 0 or negative - show as red bar going backwards
          healthElement.style.width = '0%';
          hpElement.textContent = `${char.currentHP}/${char.maxHP} HP (Unconscious)`;
        } else if (!isDead) {
          healthElement.style.width = `${percentage}%`;
          if (char.isStabilized) {
            hpElement.textContent = `${char.currentHP}/${char.maxHP} HP (Stabilized)`;
          } else {
            hpElement.textContent = `${char.currentHP}/${char.maxHP} HP`;
          }
        }
        
        // Show/hide skull overlay
        if (skullElement) {
          skullElement.style.display = isDead ? 'block' : 'none';
        }
        
        // Render Wild Shape bar for Batula
        if (index === 4 && char.isWildShaped) {
          const wildHealthElement = document.getElementById('health-4-wild');
          const wildHpElement = document.getElementById('hp-4-wild');
          const wildPercentage = (char.wildShapeCurrentHP / char.wildShapeMaxHP) * 100;
          wildHealthElement.style.width = `${wildPercentage}%`;
          wildHpElement.textContent = `Wild Shape: ${char.wildShapeCurrentHP}/${char.wildShapeMaxHP} HP`;
        }
        
        // Update Wild Shape button state for Batula
        if (index === 4) {
          const wildShapeBtn = document.getElementById('wild-shape-btn');
          if (wildShapeBtn) {
            wildShapeBtn.disabled = char.wildShapeUsesRemaining === 0 && !char.isWildShaped;
          }
        }
      });
      // Adjust sizes after rendering any changes
      resizeLayout();
    }

    function updateHealth(change) {
      if (selectedNavIndex === -1) return; // No action if no character is selected
      const charIndex = navOrder[selectedNavIndex];
      const char = characters[charIndex];
      
      // If Batula is in Wild Shape, modify Wild Shape HP instead
      if (charIndex === 4 && char.isWildShaped) {
        if (change > 0 && char.wildShapeCurrentHP === char.wildShapeMaxHP) return; // No increase if at max HP
        char.wildShapeCurrentHP = Math.max(0, Math.min(char.wildShapeMaxHP, char.wildShapeCurrentHP + change));
        
        // If Wild Shape HP hits 0, revert to normal form
        if (char.wildShapeCurrentHP === 0) {
          char.isWildShaped = false;
          document.getElementById('wild-shape-bar-wrapper').style.display = 'none';
          document.getElementById('wild-shape-btn').classList.remove('active');
        }
      } else {
        // Allow negative HP up to -negativeMaxHP (death threshold)
        const minHP = -char.negativeMaxHP;
        if (change > 0 && char.currentHP === char.maxHP) return; // No increase if at max HP
        
        const wasUnconscious = char.currentHP <= 0;
        char.currentHP = Math.max(minHP, Math.min(char.maxHP, char.currentHP + change));
        const isNowConscious = char.currentHP > 0;
        
        // If character was unconscious and is now conscious, mark as stabilized
        if (wasUnconscious && isNowConscious && !char.isStabilized) {
          char.isStabilized = true;
        }
      }
      
      const hpChangeElement = document.getElementById(`hp-change-${charIndex}`);
      char.changeCounter += change;
      hpChangeElement.textContent = `${char.changeCounter > 0 ? "+" : ""}${char.changeCounter}`;
      hpChangeElement.style.display = "inline-block";
      // Force re-trigger of animation
      hpChangeElement.classList.remove('hp-change');
      void hpChangeElement.offsetWidth; // Trigger reflow
      hpChangeElement.classList.add('hp-change');
      
      // Clear existing timeout
      if (char.changeTimeout) clearTimeout(char.changeTimeout);
      
      // Set new timeout to hide change text
      char.changeTimeout = setTimeout(() => {
        hpChangeElement.style.display = "none";
        char.changeCounter = 0;
      }, 1000);

      renderCharacters();
    }

    function selectCharacter(navIndex) {
      // Hide HP change text for previously selected character
      if (selectedNavIndex !== -1) {
        const prevCharIndex = navOrder[selectedNavIndex];
        const prevHpChangeElement = document.getElementById(`hp-change-${prevCharIndex}`);
        if (prevHpChangeElement) {
          prevHpChangeElement.style.display = "none";
          characters[prevCharIndex].changeCounter = 0;
          if (characters[prevCharIndex].changeTimeout) {
            clearTimeout(characters[prevCharIndex].changeTimeout);
          }
        }
      }
      selectedNavIndex = Math.max(-1, Math.min(navOrder.length - 1, navIndex));
      renderCharacters();
    }

    function deselectCharacter() {
      if (selectedNavIndex !== -1) {
        const prevCharIndex = navOrder[selectedNavIndex];
        const prevHpChangeElement = document.getElementById(`hp-change-${prevCharIndex}`);
        if (prevHpChangeElement) {
          prevHpChangeElement.style.display = "none";
          characters[prevCharIndex].changeCounter = 0;
          if (characters[prevCharIndex].changeTimeout) {
            clearTimeout(characters[prevCharIndex].changeTimeout);
          }
        }
        selectedNavIndex = -1;
        renderCharacters();
      }
    }

    // Dynamically size portraits and health bar heights to fill the window nicely
    function resizeLayout() {
      const characterList = document.getElementById('character-list');
      const allContainers = characterList.querySelectorAll('.character-container');
      if (!allContainers.length) return;

      const listStyle = getComputedStyle(characterList);
      const gapPx = parseFloat(listStyle.gap || '0') || 0;
      const totalGap = gapPx * Math.max(0, allContainers.length - 1);
      const listHeight = characterList.clientHeight;
      const available = Math.max(0, listHeight - totalGap);
      const perItem = allContainers.length ? available / allContainers.length : 0;

      allContainers.forEach((container) => {
        // Portrait size scales with item height
        const portrait = container.querySelector('.portrait');
        if (portrait) {
          const size = Math.round(Math.max(48, Math.min(200, perItem * 0.65)));
          portrait.style.width = size + 'px';
          portrait.style.height = size + 'px';
          const bw = Math.max(2, Math.min(6, Math.round(size * 0.03)));
          portrait.style.borderWidth = bw + 'px';
        }

        // Health bar wrapper height scales with item height
        const barWrappers = container.querySelectorAll('.bg-gray-700');
        if (barWrappers.length) {
          const barH = Math.round(Math.max(6, Math.min(28, perItem * 0.18)));
          barWrappers.forEach(barWrapper => {
            barWrapper.style.height = barH + 'px';
          });
        }

        // Wild Shape button font size
        const wildShapeBtn = container.querySelector('.wild-shape-btn');
        if (wildShapeBtn) {
          const btnFontSize = Math.round(Math.max(8, Math.min(14, perItem * 0.1)));
          wildShapeBtn.style.fontSize = btnFontSize + 'px';
          const btnPadding = Math.round(Math.max(2, Math.min(8, perItem * 0.05)));
          wildShapeBtn.style.padding = `${btnPadding}px ${btnPadding * 1.5}px`;
        }
      });
    }

    document.addEventListener("keydown", (e) => {
      e.preventDefault();
      if (e.key === "Escape") {
        deselectCharacter();
      } else if (e.key >= "1" && e.key <= "5") {
        selectCharacter(parseInt(e.key) - 1);
      } else if (e.key === "ArrowUp") {
        if (selectedNavIndex === -1) {
          selectCharacter(navOrder.length - 1); // Select Immeral
        } else if (selectedNavIndex === 0) {
          deselectCharacter(); // Deselect if on Zendith
        } else {
          selectCharacter(selectedNavIndex - 1);
        }
      } else if (e.key === "ArrowDown") {
        if (selectedNavIndex === -1) {
          selectCharacter(0); // Select Zendith
        } else if (selectedNavIndex === navOrder.length - 1) {
          deselectCharacter(); // Deselect if on Immeral
        } else {
          selectCharacter(selectedNavIndex + 1);
        }
      } else if (e.key === "ArrowLeft") {
        updateHealth(-1);
      } else if (e.key === "ArrowRight") {
        updateHealth(1);
      }
    });

    document.addEventListener("click", (e) => {
      const charContainer = e.target.closest('.character-container');
      if (charContainer) {
        const index = parseInt(charContainer.id.split('-')[1]);
        const navIndex = navOrder.indexOf(index);
        selectCharacter(navIndex);
      } else {
        deselectCharacter();
      }
    });

    // Toggle Wild Shape for Batula
    function toggleWildShape() {
      const batula = characters[4];
      
      if (!batula.isWildShaped) {
        // Check if uses are available
        if (batula.wildShapeUsesRemaining === 0) {
          return; // No uses remaining
        }
        
        // Activate Wild Shape - prompt for HP
        const wildHP = prompt("Enter Wild Shape Max HP:");
        if (wildHP && !isNaN(wildHP) && parseInt(wildHP) > 0) {
          batula.wildShapeMaxHP = parseInt(wildHP);
          batula.wildShapeCurrentHP = parseInt(wildHP);
          batula.isWildShaped = true;
          batula.wildShapeUsesRemaining--;
          document.getElementById('wild-shape-bar-wrapper').style.display = 'block';
          document.getElementById('wild-shape-btn').classList.add('active');
          renderCharacters();
        }
      } else {
        // Deactivate Wild Shape - revert to normal form
        batula.isWildShaped = false;
        batula.wildShapeCurrentHP = 0;
        batula.wildShapeMaxHP = 0;
        document.getElementById('wild-shape-bar-wrapper').style.display = 'none';
        document.getElementById('wild-shape-btn').classList.remove('active');
        renderCharacters();
      }
    }

    // Recompute sizes on window resize and when DOM is ready
    window.addEventListener('resize', resizeLayout);
    document.addEventListener('DOMContentLoaded', resizeLayout);

    // Listen for commands from control server (server.html)
    const STORAGE_KEY = 'hp-tracker-control';
    let lastProcessedTimestamp = 0;

    function processCommand(command) {
      if (!command || command.timestamp <= lastProcessedTimestamp) return;
      lastProcessedTimestamp = command.timestamp;

      if (command.type === 'hpChange') {
        // Select character and apply HP change
        const navIndex = navOrder.indexOf(command.characterIndex);
        if (navIndex !== -1) {
          selectCharacter(navIndex);
          updateHealth(command.change);
        }
      } else if (command.type === 'wildShape') {
        const batula = characters[4];
        if (command.action === 'activate' && command.maxHP) {
          if (batula.wildShapeUsesRemaining > 0 || batula.isWildShaped) {
            batula.wildShapeMaxHP = command.maxHP;
            batula.wildShapeCurrentHP = command.maxHP;
            if (!batula.isWildShaped) {
              batula.wildShapeUsesRemaining--;
            }
            batula.isWildShaped = true;
            document.getElementById('wild-shape-bar-wrapper').style.display = 'block';
            document.getElementById('wild-shape-btn').classList.add('active');
            renderCharacters();
          }
        } else if (command.action === 'deactivate') {
          batula.isWildShaped = false;
          batula.wildShapeCurrentHP = 0;
          batula.wildShapeMaxHP = 0;
          document.getElementById('wild-shape-bar-wrapper').style.display = 'none';
          document.getElementById('wild-shape-btn').classList.remove('active');
          renderCharacters();
        }
      } else if (command.type === 'removeStabilized') {
        // Remove stabilized status from character
        if (command.characterIndex >= 0 && command.characterIndex < characters.length) {
          characters[command.characterIndex].isStabilized = false;
          renderCharacters();
        }
      } else if (command.type === 'recoverWildShape') {
        // Recover Wild Shape use for Batula
        const batula = characters[4];
        batula.wildShapeUsesRemaining = 1;
        renderCharacters();
      }
    }

    // Listen for storage events from server.html
    window.addEventListener('storage', (e) => {
      if (e.key === STORAGE_KEY && e.newValue) {
        try {
          const command = JSON.parse(e.newValue);
          processCommand(command);
        } catch (err) {
          console.error('Failed to parse command:', err);
        }
      }
    });

    // Also check localStorage periodically (for same-window testing)
    setInterval(() => {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          const command = JSON.parse(stored);
          processCommand(command);
        } catch (err) {
          console.error('Failed to parse stored command:', err);
        }
      }
    }, 100);

    // Initial render
    renderCharacters();
  </script>
</body>
</html>