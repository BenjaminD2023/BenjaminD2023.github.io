<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HP Tracker Control Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #1f2937;
      color: white;
      padding: 2rem;
    }
    .control-panel {
      max-width: 600px;
      margin: 0 auto;
      background: #374151;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .character-btn {
      padding: 0.75rem 1rem;
      margin: 0.25rem;
      border: 2px solid #4b5563;
      border-radius: 8px;
      background: #1f2937;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .character-btn:hover {
      border-color: #facc15;
    }
    .character-btn.selected {
      border-color: #facc15;
      background: #facc15;
      color: #1f2937;
      font-weight: bold;
    }
    .hp-btn {
      padding: 1rem 1.5rem;
      margin: 0.5rem;
      border-radius: 8px;
      font-size: 1.25rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .hp-btn.damage {
      background: #dc2626;
      color: white;
    }
    .hp-btn.damage:hover {
      background: #b91c1c;
    }
    .hp-btn.heal {
      background: #10b981;
      color: white;
    }
    .hp-btn.heal:hover {
      background: #059669;
    }
    .wild-shape-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #1f2937;
      border-radius: 8px;
      border: 2px solid #10b981;
    }
    .acererak-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #1f2937;
      border-radius: 8px;
      border: 2px solid #dc2626;
    }
    .dicecam-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #1f2937;
      border-radius: 8px;
      border: 2px solid #3b82f6;
    }
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .action-buttons button {
      flex: 1;
      padding: 0.75rem;
      font-size: 0.9rem;
    }
    .action-btn.melee-action {
      background: #dc2626;
    }
    .action-btn.melee-action:hover {
      background: #b91c1c;
    }
    .action-btn.ranged-action {
      background: #3b82f6;
    }
    .action-btn.ranged-action:hover {
      background: #2563eb;
    }
    .action-btn.skill-action {
      background: #10b981;
    }
    .action-btn.skill-action:hover {
      background: #059669;
    }
    .action-btn.reset-action {
      background: #6b7280;
    }
    .action-btn.reset-action:hover {
      background: #4b5563;
    }
    .input-field {
      padding: 0.5rem;
      border-radius: 6px;
      border: 2px solid #4b5563;
      background: #1f2937;
      color: white;
      font-size: 1rem;
      width: 100%;
      margin: 0.5rem 0;
    }
    .action-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin: 0.5rem 0.25rem;
    }
    .action-btn.activate {
      background: #10b981;
      color: white;
    }
    .action-btn.deactivate {
      background: #f59e0b;
      color: white;
    }
    .status {
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      background: #1f2937;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <h1 class="text-3xl font-bold mb-6 text-center">HP Tracker Control</h1>
    
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Select Character</h2>
      <div class="flex flex-wrap justify-center">
        <button class="character-btn" data-index="0">Zendith</button>
        <button class="character-btn" data-index="1">Terra</button>
        <button class="character-btn" data-index="2">Feathers</button>
        <button class="character-btn" data-index="3">Immeral</button>
        <button class="character-btn" data-index="4">Batula</button>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">HP Change Amount</h2>
      <input type="number" id="hp-amount" class="input-field" value="1" min="1">
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Apply HP Change</h2>
      <div class="flex justify-center">
        <button class="hp-btn damage" id="damage-btn">Damage (-)</button>
        <button class="hp-btn heal" id="heal-btn">Heal (+)</button>
      </div>
    </div>

    <div class="wild-shape-section">
      <h2 class="text-xl font-semibold mb-3">Wild Shape (Batula)</h2>
      <input type="number" id="wild-shape-hp" class="input-field" placeholder="Enter Wild Shape Max HP">
      <div class="flex justify-center">
        <button class="action-btn activate" id="activate-wild-shape">Activate</button>
        <button class="action-btn deactivate" id="deactivate-wild-shape">Deactivate</button>
      </div>
    </div>

    <div class="acererak-section">
      <h2 class="text-xl font-semibold mb-3">‚ö†Ô∏è Acererak - The Tomb Builder <kbd class="px-2 py-1 bg-gray-700 rounded text-xs ml-2">K</kbd></h2>
      
      <label class="text-sm text-gray-300">Activation</label>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="action-btn activate" id="acererak-activate-btn" style="flex: 1;">Reveal Tomb Builder</button>
        <button class="action-btn deactivate" id="acererak-deactivate-btn" style="flex: 1;">Show Poster</button>
      </div>

      <label class="text-sm text-gray-300">HP Damage Amount</label>
      <input type="number" id="acererak-hp-amount" class="input-field" value="5" min="1">
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="hp-btn damage" id="acererak-damage-btn" style="flex: 1; margin: 0;">Damage (-)</button>
        <button class="hp-btn heal" id="acererak-heal-btn" style="flex: 1; margin: 0;">Heal (+)</button>
      </div>
      
      <label class="text-sm text-gray-300">Action Type</label>
      <div class="action-buttons">
        <button class="action-btn melee-action" id="acererak-melee-btn">‚öîÔ∏è Melee</button>
        <button class="action-btn ranged-action" id="acererak-ranged-btn">üèπ Ranged</button>
        <button class="action-btn skill-action" id="acererak-skill-btn">‚ú® Skill</button>
      </div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button class="action-btn reset-action" id="acererak-clear-action-btn" style="flex: 1; background: #6b7280;">Clear Action</button>
        <button class="action-btn reset-action" id="acererak-reset-btn" style="flex: 1;">Reset HP</button>
      </div>
    </div>

    <div class="dicecam-section">
      <h2 class="text-xl font-semibold mb-3">üé≤ Dice Cam Control</h2>
      
      <label class="text-sm text-gray-300">Camera Control</label>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="action-btn activate" id="dicecam-enable-btn" style="flex: 1;">Enable Camera</button>
        <button class="action-btn deactivate" id="dicecam-disable-btn" style="flex: 1;">Disable Camera</button>
      </div>
      
      <label class="text-sm text-gray-300">Video Source</label>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; align-items: flex-start;">
        <div id="dicecam-source-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem; flex: 1;"></div>
        <button class="action-btn" id="refresh-cameras-btn" style="margin: 0; padding: 0.5rem 1rem; background: #6b7280; white-space: nowrap;">üîÑ Refresh</button>
      </div>
      
      <label class="text-sm text-gray-300">Roll Type</label>
      <div id="dicecam-type-buttons" class="action-buttons" style="flex-wrap: wrap;">
        <button class="action-btn dicecam-type-btn" data-type="ready">Ready</button>
        <button class="action-btn dicecam-type-btn" data-type="save">Save</button>
        <button class="action-btn dicecam-type-btn" data-type="check">Check</button>
        <button class="action-btn dicecam-type-btn" data-type="attack">Attack</button>
        <button class="action-btn dicecam-type-btn" data-type="damage">Damage</button>
      </div>
      
      <div id="dicecam-save-controls" style="display: none;">
        <label class="text-sm text-gray-300 mt-3">Difficulty Class (DC)</label>
        <input type="number" id="dicecam-dc" class="input-field" placeholder="Enter DC (e.g., 15)" value="15">
        
        <label class="text-sm text-gray-300 mt-3">Save Results (per character)</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Zendith</div>
            <div class="save-btn-group" data-index="0">
              <button class="action-btn save-result-btn" data-index="0" data-value="pending" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">-</button>
              <button class="action-btn save-result-btn" data-index="0" data-value="success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úì</button>
              <button class="action-btn save-result-btn" data-index="0" data-value="fail" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úó</button>
            </div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Terra</div>
            <div class="save-btn-group" data-index="1">
              <button class="action-btn save-result-btn" data-index="1" data-value="pending" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">-</button>
              <button class="action-btn save-result-btn" data-index="1" data-value="success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úì</button>
              <button class="action-btn save-result-btn" data-index="1" data-value="fail" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úó</button>
            </div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Feathers</div>
            <div class="save-btn-group" data-index="2">
              <button class="action-btn save-result-btn" data-index="2" data-value="pending" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">-</button>
              <button class="action-btn save-result-btn" data-index="2" data-value="success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úì</button>
              <button class="action-btn save-result-btn" data-index="2" data-value="fail" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úó</button>
            </div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Immeral</div>
            <div class="save-btn-group" data-index="3">
              <button class="action-btn save-result-btn" data-index="3" data-value="pending" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">-</button>
              <button class="action-btn save-result-btn" data-index="3" data-value="success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úì</button>
              <button class="action-btn save-result-btn" data-index="3" data-value="fail" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úó</button>
            </div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Batula</div>
            <div class="save-btn-group" data-index="4">
              <button class="action-btn save-result-btn" data-index="4" data-value="pending" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">-</button>
              <button class="action-btn save-result-btn" data-index="4" data-value="success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úì</button>
              <button class="action-btn save-result-btn" data-index="4" data-value="fail" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úó</button>
            </div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #dc2626; margin-bottom: 0.25rem; font-weight: bold;">Tomb Builder</div>
            <div class="save-btn-group" data-index="5">
              <button class="action-btn save-result-btn" data-index="5" data-value="pending" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; border-color: #dc2626;">-</button>
              <button class="action-btn save-result-btn" data-index="5" data-value="success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; border-color: #10b981;">‚úì</button>
              <button class="action-btn save-result-btn" data-index="5" data-value="fail" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; border-color: #dc2626;">‚úó</button>
            </div>
          </div>
        </div>
        <button class="action-btn activate" id="dicecam-update-save-btn" style="margin-top: 1rem;">Update Save Results</button>
      </div>
      
      <div id="dicecam-ready-controls" style="display: none;">
        <label class="text-sm text-gray-300 mt-3">Special Roll Result</label>
        <input type="number" id="dicecam-ready-result" class="input-field" placeholder="Enter roll result (e.g., 20 for nat 20)" value="">
        
        <button class="action-btn activate" id="dicecam-update-ready-btn" style="margin-top: 1rem;">Update Roll Result</button>
      </div>
      
      <div id="dicecam-roll-controls">
        <label class="text-sm text-gray-300 mt-3">Roll Result</label>
        <input type="number" id="dicecam-result" class="input-field" placeholder="Enter roll result (e.g., 15)" value="">
        
        <label class="text-sm text-gray-300">Modifier</label>
        <input type="number" id="dicecam-modifier" class="input-field" placeholder="Enter modifier (e.g., +3)" value="0">
        
        <button class="action-btn activate" id="dicecam-update-result-btn" style="margin-top: 1rem;">Update Roll Result</button>
      </div>
      
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button class="action-btn reset-action" id="dicecam-reset-btn" style="flex: 1;">Reset Dice Cam</button>
      </div>
    </div>

    <div class="status">
      <p id="status-message">Ready...</p>
      <p class="text-sm text-gray-400 mt-2">Selected: <span id="selected-char">None</span></p>
    </div>

    <div class="mt-6 p-4 bg-gray-800 rounded-lg">
      <h3 class="text-sm font-semibold mb-2 text-center text-gray-300">Keyboard Shortcuts</h3>
      <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Z</kbd> Zendith</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">T</kbd> Terra</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">F</kbd> Feathers</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">I</kbd> Immeral</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">B</kbd> Batula</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">W</kbd> Wild Shape Focus</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">D</kbd> Deactivate Wild Shape</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">E</kbd> Recover Wild Shape Use</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">R</kbd> Remove Stabilized</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">C</kbd> Clear Selection</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">K</kbd> Toggle Acererak/Player HP</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">A</kbd> Clear Acererak Action</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">M</kbd> Acererak Melee</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">O</kbd> Acererak Ranged</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">S</kbd> Acererak Skill</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">-</kbd> Damage (context-aware)</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">+</kbd> Heal (context-aware)</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Enter</kbd> Apply Damage</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Shift+Enter</kbd> Apply Heal</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Esc</kbd> Deselect</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">.</kbd> Pass Save</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">/</kbd> Fail Save</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Shift+U</kbd> Update Save Results</div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'hp-tracker-control';
    const ACERERAK_KEY = 'acererak-control';
    const DICECAM_KEY = 'dicecam-control';
    let selectedCharacter = null;
    let acererakHpDeducted = 0;
    let dicecamCurrentType = 'ready';
    let saveResults = Array(6).fill('pending');
    // Added: keyboard navigation state for Save results
    let currentSaveIndex = 0;

    // Display current port in status message
    function updatePortDisplay() {
      const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
      const host = window.location.hostname;
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = `Ready. Running on ${host}:${port}`;
    }

    // Initialize port display on load
    updatePortDisplay();
    
    // Enumerate available cameras
    async function getCameraDevices() {
      try {
        // Request permission first
        await navigator.mediaDevices.getUserMedia({ video: true });
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        return videoDevices;
      } catch (err) {
        console.error('Error enumerating cameras:', err);
        showStatus('Camera permission required to list devices', 'error');
        return [];
      }
    }
    
    // Populate camera buttons instead of dropdown
    async function populateCameraList() {
      const container = document.getElementById('dicecam-source-buttons');
      container.innerHTML = '<span style="color:#9ca3af;">Loading cameras...</span>';
      const cameras = await getCameraDevices();
      container.innerHTML = '';
      if (cameras.length === 0) {
        container.innerHTML = '<span style="color:#ef4444;">No cameras found</span>';
        return;
      }
      cameras.forEach((camera, index) => {
        const btn = document.createElement('button');
        btn.className = 'action-btn';
        btn.style.padding = '0.5rem 0.75rem';
        btn.textContent = camera.label || `Camera ${index + 1}`;
        btn.addEventListener('click', () => {
          if (camera.deviceId) {
            sendDiceCamCommand({ type: 'changeSource', deviceId: camera.deviceId });
            showStatus(`Dice Cam: Switched to ${btn.textContent}`, 'success');
          }
        });
        container.appendChild(btn);
      });
      showStatus(`Found ${cameras.length} camera(s)`, 'success');
    }
    
    // Initialize camera list on load
    populateCameraList();

    // Initialize Acererak HP display from localStorage if available
    const storedAcererakData = localStorage.getItem(ACERERAK_KEY);
    if (storedAcererakData) {
      try {
        const data = JSON.parse(storedAcererakData);
      } catch (err) {
        console.error('Failed to parse Acererak data:', err);
      }
    }

    // Character buttons
    const characterBtns = document.querySelectorAll('.character-btn');
    characterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        characterBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedCharacter = parseInt(btn.dataset.index);
        document.getElementById('selected-char').textContent = btn.textContent;
      });
    });

    // HP Change buttons
    document.getElementById('damage-btn').addEventListener('click', () => {
      applyHPChange(-1 * parseInt(document.getElementById('hp-amount').value));
    });

    document.getElementById('heal-btn').addEventListener('click', () => {
      applyHPChange(parseInt(document.getElementById('hp-amount').value));
    });

    // Wild Shape buttons
    document.getElementById('activate-wild-shape').addEventListener('click', () => {
      const wildHP = parseInt(document.getElementById('wild-shape-hp').value);
      if (!wildHP || wildHP <= 0) {
        showStatus('Please enter a valid HP value', 'error');
        return;
      }
      sendCommand({
        type: 'wildShape',
        action: 'activate',
        maxHP: wildHP
      });
      showStatus(`Wild Shape activated with ${wildHP} HP`, 'success');
    });

    document.getElementById('deactivate-wild-shape').addEventListener('click', () => {
      sendCommand({
        type: 'wildShape',
        action: 'deactivate'
      });
      showStatus('Wild Shape deactivated', 'success');
    });

    // Acererak buttons
    document.getElementById('acererak-activate-btn').addEventListener('click', () => {
      sendAcererakCommand({ type: 'activate' });
      showStatus('Acererak: Revealed Tomb Builder', 'success');
    });

    document.getElementById('acererak-deactivate-btn').addEventListener('click', () => {
      sendAcererakCommand({ type: 'deactivate' });
      showStatus('Acererak: Showing Poster', 'success');
    });

    document.getElementById('acererak-damage-btn').addEventListener('click', () => {
      const amount = parseInt(document.getElementById('acererak-hp-amount').value) || 5;
      sendAcererakCommand({ type: 'hpChange', change: -amount });
      showStatus(`Acererak: Applied ${-amount} HP`, 'success');
    });

    document.getElementById('acererak-heal-btn').addEventListener('click', () => {
      const amount = parseInt(document.getElementById('acererak-hp-amount').value) || 5;
      sendAcererakCommand({ type: 'hpChange', change: amount });
      showStatus(`Acererak: Applied +${amount} HP`, 'success');
    });

    document.getElementById('acererak-melee-btn').addEventListener('click', () => {
      sendAcererakCommand({ type: 'action', action: 'melee' });
      showStatus('Acererak: Melee Action', 'success');
    });

    document.getElementById('acererak-ranged-btn').addEventListener('click', () => {
      sendAcererakCommand({ type: 'action', action: 'ranged' });
      showStatus('Acererak: Ranged Action', 'success');
    });

    document.getElementById('acererak-skill-btn').addEventListener('click', () => {
      sendAcererakCommand({ type: 'action', action: 'skill' });
      showStatus('Acererak: Skill Action', 'success');
    });

    document.getElementById('acererak-clear-action-btn').addEventListener('click', () => {
      sendAcererakCommand({ type: 'clearAction' });
      showStatus('Acererak: Action Cleared', 'success');
    });

    document.getElementById('acererak-reset-btn').addEventListener('click', () => {
      sendAcererakCommand({ type: 'reset' });
      showStatus('Acererak: HP Reset', 'success');
    });

    function applyHPChange(change) {
      if (selectedCharacter === null) {
        showStatus('Please select a character first', 'error');
        return;
      }

      sendCommand({
        type: 'hpChange',
        characterIndex: selectedCharacter,
        change: change
      });

      showStatus(`Applied ${change > 0 ? '+' : ''}${change} HP to ${characterBtns[selectedCharacter].textContent}`, 'success');
    }

    function sendCommand(command) {
      const timestamp = Date.now();
      const commandWithTime = { ...command, timestamp };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(commandWithTime));
      
      window.dispatchEvent(new StorageEvent('storage', {
        key: STORAGE_KEY,
        newValue: JSON.stringify(commandWithTime),
        url: window.location.href,
        storageArea: localStorage
      }));
    }

    function sendAcererakCommand(command) {
      const timestamp = Date.now();
      const commandWithTime = { ...command, timestamp };
      localStorage.setItem(ACERERAK_KEY, JSON.stringify(commandWithTime));
      
      if (command.type === 'hpChange') {
        acererakHpDeducted += command.change || 0;
        if (acererakHpDeducted < 0) {
          acererakHpDeducted = 0;
        }
        document.getElementById('acererak-hp-display').textContent = acererakHpDeducted;
      } else if (command.type === 'reset') {
        acererakHpDeducted = 0;
        document.getElementById('acererak-hp-display').textContent = acererakHpDeducted;
      }
      
      window.dispatchEvent(new StorageEvent('storage', {
        key: ACERERAK_KEY,
        newValue: JSON.stringify(commandWithTime),
        url: window.location.href,
        storageArea: localStorage
      }));
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : 'white';
      
      setTimeout(() => {
        updatePortDisplay();
        statusEl.style.color = 'white';
      }, 3000);
    }

    // Dice Cam functions
    function sendDiceCamCommand(command) {
      const commandWithTime = { ...command, timestamp: Date.now() };
      localStorage.setItem(DICECAM_KEY, JSON.stringify(commandWithTime));
      
      window.dispatchEvent(new StorageEvent('storage', {
        key: DICECAM_KEY,
        newValue: JSON.stringify(commandWithTime),
        url: window.location.href,
        storageArea: localStorage
      }));
    }

    function updateDiceCamType(type) {
      const nextType = type || dicecamCurrentType || 'ready';
      dicecamCurrentType = nextType;

      const typeBtns = document.querySelectorAll('.dicecam-type-btn');
      typeBtns.forEach(b => {
        if (b.dataset.type === nextType) {
          b.style.outline = '3px solid #3b82f6';
        } else {
          b.style.outline = 'none';
        }
      });

      const saveControls = document.getElementById('dicecam-save-controls');
      const readyControls = document.getElementById('dicecam-ready-controls');
      const rollControls = document.getElementById('dicecam-roll-controls');
      
      if (nextType === 'ready') {
        saveControls.style.display = 'none';
        readyControls.style.display = 'block';
        rollControls.style.display = 'none';
        // Clear save group highlight when leaving Save mode
        highlightSaveGroup(null);
        sendDiceCamCommand({ type: 'setType', rollType: nextType });
      } else if (nextType === 'save') {
        saveControls.style.display = 'block';
        readyControls.style.display = 'none';
        rollControls.style.display = 'none';
        const dc = parseInt(document.getElementById('dicecam-dc').value) || 15;
        // Reset and highlight first save group on entering Save mode
        currentSaveIndex = 0;
        highlightSaveGroup(currentSaveIndex);
        sendDiceCamCommand({ type: 'setType', rollType: nextType, dc: dc });
      } else {
        saveControls.style.display = 'none';
        readyControls.style.display = 'none';
        rollControls.style.display = 'block';
        // Clear save group highlight when leaving Save mode
        highlightSaveGroup(null);
        sendDiceCamCommand({ type: 'setType', rollType: nextType });
      }
      
      showStatus(`Dice Cam: ${nextType.charAt(0).toUpperCase() + nextType.slice(1)} mode`, 'success');
    }

    document.querySelectorAll('.dicecam-type-btn').forEach(btn => {
      btn.addEventListener('click', () => updateDiceCamType(btn.dataset.type));
    });

    function updateDiceCamSaveResults() {
      const dc = parseInt(document.getElementById('dicecam-dc').value) || 15;
      sendDiceCamCommand({ type: 'setResult', rollType: 'save', saveResults: saveResults, dc: dc });
      showStatus(`Dice Cam: Save results updated (DC ${dc})`, 'success');
    }

    function updateDiceCamReadyResult() {
      const result = document.getElementById('dicecam-ready-result').value;
      
      if (result === '' || result === null) {
        showStatus('Please enter a roll result', 'error');
        return;
      }
      
      sendDiceCamCommand({ 
        type: 'setResult', 
        rollType: 'ready',
        result: result
      });
      
      showStatus(`Dice Cam: Special Roll ${result}`, 'success');
    }

    function updateDiceCamRollResult() {
      const result = document.getElementById('dicecam-result').value;
      const modifier = parseInt(document.getElementById('dicecam-modifier').value) || 0;
      
      // Allow showing just modifier without roll result
      if (result === '' || result === null) {
        // Show only modifier
        sendDiceCamCommand({ 
          type: 'setModifier', 
          rollType: dicecamCurrentType,
          modifier: modifier 
        });
        showStatus(`Dice Cam: Modifier ${modifier >= 0 ? '+' : ''}${modifier}`, 'success');
        return;
      }
      
      // Show both result and modifier
      sendDiceCamCommand({ 
        type: 'setResult', 
        rollType: dicecamCurrentType,
        result: result,
        modifier: modifier 
      });
      
      showStatus(`Dice Cam: Roll ${result} (${modifier >= 0 ? '+' : ''}${modifier})`, 'success');
    }

    function resetDiceCam() {
      sendDiceCamCommand({ type: 'reset' });
      document.getElementById('dicecam-ready-result').value = '';
      document.getElementById('dicecam-result').value = '';
      document.getElementById('dicecam-modifier').value = '0';
      saveResults = Array(6).fill('pending');
      document.querySelectorAll('.save-btn-group').forEach(group => {
        const idx = parseInt(group.dataset.index);
        setSaveGroupSelected(group, 'pending');
      });
      dicecamCurrentType = 'ready';
      // Clear any save selection highlight
      highlightSaveGroup(null);
      updateDiceCamType('ready');
      showStatus('Dice Cam: Reset', 'success');
    }

    function setSaveGroupSelected(groupEl, value) {
      const buttons = groupEl.querySelectorAll('.save-result-btn');
      buttons.forEach(b => {
        const v = b.dataset.value;
        b.style.background = '#4b5563';
        if (v === value) {
          if (v === 'success') b.style.background = '#10b981';
          else if (v === 'fail') b.style.background = '#dc2626';
          else b.style.background = '#6b7280';
        }
      });
    }

    // Added: helpers for keyboard save entry
    function highlightSaveGroup(index) {
      const groups = document.querySelectorAll('.save-btn-group');
      groups.forEach(g => {
        g.style.outline = 'none';
        g.style.borderRadius = '6px';
      });
      if (index === null || index === undefined) return;
      const target = document.querySelector(`.save-btn-group[data-index="${index}"]`);
      if (target) {
        target.style.outline = '3px solid #3b82f6';
      }
    }

    function setSaveResultAt(index, value) {
      const group = document.querySelector(`.save-btn-group[data-index="${index}"]`);
      if (!group) return;
      saveResults[index] = value;
      setSaveGroupSelected(group, value);
    }

    function advanceSaveIndex() {
      currentSaveIndex = (currentSaveIndex + 1) % 6;
      highlightSaveGroup(currentSaveIndex);
    }

    document.querySelectorAll('.save-result-btn').forEach(btn => {
      const idx = parseInt(btn.dataset.index);
      if (btn.dataset.value === 'pending') {
        const group = btn.closest('.save-btn-group');
        setSaveGroupSelected(group, 'pending');
      }
      btn.addEventListener('click', () => {
        const index = parseInt(btn.dataset.index);
        const value = btn.dataset.value;
        saveResults[index] = value;
        const group = btn.closest('.save-btn-group');
        setSaveGroupSelected(group, value);
        // Also move current selection to clicked group for continued keyboard entry
        currentSaveIndex = index;
        highlightSaveGroup(currentSaveIndex);
      });
    });

    document.getElementById('dicecam-enable-btn').addEventListener('click', () => {
      sendDiceCamCommand({ type: 'enableCamera' });
      showStatus('Dice Cam: Camera enabled', 'success');
    });
    
    document.getElementById('dicecam-disable-btn').addEventListener('click', () => {
      sendDiceCamCommand({ type: 'disableCamera' });
      showStatus('Dice Cam: Camera disabled', 'success');
    });
    
    document.getElementById('refresh-cameras-btn').addEventListener('click', () => {
      populateCameraList();
    });
    
    document.getElementById('dicecam-update-save-btn').addEventListener('click', updateDiceCamSaveResults);
    document.getElementById('dicecam-update-ready-btn').addEventListener('click', updateDiceCamReadyResult);
    document.getElementById('dicecam-update-result-btn').addEventListener('click', updateDiceCamRollResult);
    document.getElementById('dicecam-reset-btn').addEventListener('click', resetDiceCam);

    // Helper: Check if user is typing in ANY input field
    function isTypingInInput() {
      const activeEl = document.activeElement;
      if (!activeEl) return false;
      
      const tag = activeEl.tagName;
      return tag === 'INPUT' || tag === 'TEXTAREA' || activeEl.isContentEditable;
    }

    // Global keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Bypass all shortcuts if typing in any input field
      if (isTypingInInput()) return;

      // Shift+U: Update dice cam (works for all roll types)
      if ((e.key === 'u' || e.key === 'U') && e.shiftKey) {
        e.preventDefault();
        if (dicecamCurrentType === 'save') {
          updateDiceCamSaveResults();
        } else if (dicecamCurrentType === 'ready') {
          updateDiceCamReadyResult();
        } else {
          updateDiceCamRollResult();
        }
        return;
      }

      // Save mode shortcuts (., /, Tab)
      if (dicecamCurrentType === 'save') {
        if (e.key === 'Tab') {
          e.preventDefault();
          advanceSaveIndex();
          return;
        } else if (e.key === '.') {
          e.preventDefault();
          setSaveResultAt(currentSaveIndex, 'success');
          advanceSaveIndex();
          return;
        } else if (e.key === '/') {
          e.preventDefault();
          setSaveResultAt(currentSaveIndex, 'fail');
          advanceSaveIndex();
          return;
        }
      }

      // Character selection shortcuts
      if (e.key === 'z' || e.key === 'Z') {
        e.preventDefault();
        characterBtns[0].click();
      } else if (e.key === 't' || e.key === 'T') {
        e.preventDefault();
        characterBtns[1].click();
      } else if (e.key === 'f' || e.key === 'F') {
        e.preventDefault();
        characterBtns[2].click();
      } else if (e.key === 'i' || e.key === 'I') {
        e.preventDefault();
        characterBtns[3].click();
      } else if (e.key === 'b' || e.key === 'B') {
        e.preventDefault();
        characterBtns[4].click();
      } else if (e.key === 'c' || e.key === 'C') {
        e.preventDefault();
        // Clear selection
        characterBtns.forEach(b => b.classList.remove('selected'));
        selectedCharacter = null;
        document.getElementById('selected-char').textContent = 'None';
      }
      // Wild Shape shortcuts
      else if (e.key === 'w' || e.key === 'W') {
        e.preventDefault();
        document.getElementById('wild-shape-hp').focus();
      } else if (e.key === 'd' || e.key === 'D') {
        e.preventDefault();
        document.getElementById('deactivate-wild-shape').click();
      } else if (e.key === 'e' || e.key === 'E') {
        e.preventDefault();
        sendCommand({ type: 'recoverWildShape' });
        showStatus('Wild Shape use recovered', 'success');
      }
      // Stabilized status
      else if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        if (selectedCharacter !== null) {
          sendCommand({ type: 'removeStabilized', characterIndex: selectedCharacter });
          showStatus(`Removed stabilized status from ${characterBtns[selectedCharacter].textContent}`, 'success');
        }
      }
      // Acererak shortcuts
      else if (e.key === 'k' || e.key === 'K') {
        e.preventDefault();
        // Toggle between Acererak and Player HP tracker (open acererak.html in new tab)
        window.open('acererak.html', '_blank');
      } else if (e.key === 'a' || e.key === 'A') {
        e.preventDefault();
        document.getElementById('acererak-clear-action-btn').click();
      } else if (e.key === 'm' || e.key === 'M') {
        e.preventDefault();
        document.getElementById('acererak-melee-btn').click();
      } else if (e.key === 'o' || e.key === 'O') {
        e.preventDefault();
        document.getElementById('acererak-ranged-btn').click();
      } else if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        document.getElementById('acererak-skill-btn').click();
      }
      // HP change shortcuts
      else if (e.key === '-' || e.key === '_') {
        e.preventDefault();
        document.getElementById('hp-amount').focus();
      } else if (e.key === '+' || e.key === '=') {
        e.preventDefault();
        document.getElementById('hp-amount').focus();
      } else if (e.key === 'Enter') {
        if (e.shiftKey) {
          e.preventDefault();
          document.getElementById('heal-btn').click();
        } else {
          e.preventDefault();
          document.getElementById('damage-btn').click();
        }
      } else if (e.key === 'Escape') {
        e.preventDefault();
        characterBtns.forEach(b => b.classList.remove('selected'));
        selectedCharacter = null;
        document.getElementById('selected-char').textContent = 'None';
      }
    });
    
    updateDiceCamType('ready');
  </script>
</body>
</html>
