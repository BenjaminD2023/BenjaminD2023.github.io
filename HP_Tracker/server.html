<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HP Tracker Control Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #1f2937;
      color: white;
      padding: 2rem;
    }
    .control-panel {
      max-width: 600px;
      margin: 0 auto;
      background: #374151;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .character-btn {
      padding: 0.75rem 1rem;
      margin: 0.25rem;
      border: 2px solid #4b5563;
      border-radius: 8px;
      background: #1f2937;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .character-btn:hover {
      border-color: #facc15;
    }
    .character-btn.selected {
      border-color: #facc15;
      background: #facc15;
      color: #1f2937;
      font-weight: bold;
    }
    .hp-btn {
      padding: 1rem 1.5rem;
      margin: 0.5rem;
      border-radius: 8px;
      font-size: 1.25rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .hp-btn.damage {
      background: #dc2626;
      color: white;
    }
    .hp-btn.damage:hover {
      background: #b91c1c;
    }
    .hp-btn.heal {
      background: #10b981;
      color: white;
    }
    .hp-btn.heal:hover {
      background: #059669;
    }
    .wild-shape-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #1f2937;
      border-radius: 8px;
      border: 2px solid #10b981;
    }
    .acererak-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #1f2937;
      border-radius: 8px;
      border: 2px solid #dc2626;
    }
    .dicecam-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #1f2937;
      border-radius: 8px;
      border: 2px solid #3b82f6;
    }
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .action-buttons button {
      flex: 1;
      padding: 0.75rem;
      font-size: 0.9rem;
    }
    .action-btn.melee-action {
      background: #dc2626;
    }
    .action-btn.melee-action:hover {
      background: #b91c1c;
    }
    .action-btn.ranged-action {
      background: #3b82f6;
    }
    .action-btn.ranged-action:hover {
      background: #2563eb;
    }
    .action-btn.skill-action {
      background: #10b981;
    }
    .action-btn.skill-action:hover {
      background: #059669;
    }
    .action-btn.reset-action {
      background: #6b7280;
    }
    .action-btn.reset-action:hover {
      background: #4b5563;
    }
    .input-field {
      padding: 0.5rem;
      border-radius: 6px;
      border: 2px solid #4b5563;
      background: #1f2937;
      color: white;
      font-size: 1rem;
      width: 100%;
      margin: 0.5rem 0;
    }
    .action-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin: 0.5rem 0.25rem;
    }
    .action-btn.activate {
      background: #10b981;
      color: white;
    }
    .action-btn.deactivate {
      background: #f59e0b;
      color: white;
    }
    .status {
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      background: #1f2937;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <h1 class="text-3xl font-bold mb-6 text-center">HP Tracker Control</h1>
    
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Select Character</h2>
      <div class="flex flex-wrap justify-center">
        <button class="character-btn" data-index="0">Zendith</button>
        <button class="character-btn" data-index="1">Terra</button>
        <button class="character-btn" data-index="2">Feathers</button>
        <button class="character-btn" data-index="3">Immeral</button>
        <button class="character-btn" data-index="4">Batula</button>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">HP Change Amount</h2>
      <input type="number" id="hp-amount" class="input-field" value="1" min="1">
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Apply HP Change</h2>
      <div class="flex justify-center">
        <button class="hp-btn damage" id="damage-btn">Damage (-)</button>
        <button class="hp-btn heal" id="heal-btn">Heal (+)</button>
      </div>
    </div>

    <div class="wild-shape-section">
      <h2 class="text-xl font-semibold mb-3">Wild Shape (Batula)</h2>
      <input type="number" id="wild-shape-hp" class="input-field" placeholder="Enter Wild Shape Max HP">
      <div class="flex justify-center">
        <button class="action-btn activate" id="activate-wild-shape">Activate</button>
        <button class="action-btn deactivate" id="deactivate-wild-shape">Deactivate</button>
      </div>
    </div>

    <div class="acererak-section">
      <h2 class="text-xl font-semibold mb-3">‚ö†Ô∏è Acererak - The Tomb Builder <kbd class="px-2 py-1 bg-gray-700 rounded text-xs ml-2">K</kbd></h2>
      
      <label class="text-sm text-gray-300">Activation</label>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="action-btn activate" id="acererak-activate-btn" style="flex: 1;">Reveal Tomb Builder</button>
        <button class="action-btn deactivate" id="acererak-deactivate-btn" style="flex: 1;">Show Poster</button>
      </div>

      <label class="text-sm text-gray-300">HP Damage Amount</label>
      <input type="number" id="acererak-hp-amount" class="input-field" value="5" min="1">
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="hp-btn damage" id="acererak-damage-btn" style="flex: 1; margin: 0;">Damage (-)</button>
        <button class="hp-btn heal" id="acererak-heal-btn" style="flex: 1; margin: 0;">Heal (+)</button>
      </div>
      
      <label class="text-sm text-gray-300">Action Type</label>
      <div class="action-buttons">
        <button class="action-btn melee-action" id="acererak-melee-btn">‚öîÔ∏è Melee</button>
        <button class="action-btn ranged-action" id="acererak-ranged-btn">üèπ Ranged</button>
        <button class="action-btn skill-action" id="acererak-skill-btn">‚ú® Skill</button>
      </div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button class="action-btn reset-action" id="acererak-clear-action-btn" style="flex: 1; background: #6b7280;">Clear Action</button>
        <button class="action-btn reset-action" id="acererak-reset-btn" style="flex: 1;">Reset HP</button>
      </div>
    </div>

    <div class="dicecam-section">
      <h2 class="text-xl font-semibold mb-3">üé≤ Dice Cam Control</h2>
      
      <label class="text-sm text-gray-300">Camera Control</label>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="action-btn activate" id="dicecam-enable-btn" style="flex: 1;">Enable Camera</button>
        <button class="action-btn deactivate" id="dicecam-disable-btn" style="flex: 1;">Disable Camera</button>
      </div>
      
      <label class="text-sm text-gray-300">Video Source</label>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <select id="dicecam-source-select" class="input-field" style="margin: 0; flex: 1;">
          <option value="">Loading cameras...</option>
        </select>
        <button class="action-btn" id="refresh-cameras-btn" style="margin: 0; padding: 0.5rem 1rem; background: #6b7280; white-space: nowrap;">üîÑ Refresh</button>
      </div>
      
      <label class="text-sm text-gray-300">Roll Type</label>
      <select id="dicecam-type-select" class="input-field">
        <option value="ready">Ready...</option>
        <option value="save">Saving Throw</option>
        <option value="check">Ability Check</option>
        <option value="attack">Attack Roll</option>
        <option value="damage">Damage Roll</option>
      </select>
      
      <div id="dicecam-save-controls" style="display: none;">
        <label class="text-sm text-gray-300 mt-3">Difficulty Class (DC)</label>
        <input type="number" id="dicecam-dc" class="input-field" placeholder="Enter DC (e.g., 15)" value="15">
        
        <label class="text-sm text-gray-300 mt-3">Save Results (per character)</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Zendith</div>
            <select id="save-result-0" class="input-field" style="padding: 0.25rem; font-size: 0.8rem;">
              <option value="pending">-</option>
              <option value="success">‚úì</option>
              <option value="fail">‚úó</option>
            </select>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Terra</div>
            <select id="save-result-1" class="input-field" style="padding: 0.25rem; font-size: 0.8rem;">
              <option value="pending">-</option>
              <option value="success">‚úì</option>
              <option value="fail">‚úó</option>
            </select>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Feathers</div>
            <select id="save-result-2" class="input-field" style="padding: 0.25rem; font-size: 0.8rem;">
              <option value="pending">-</option>
              <option value="success">‚úì</option>
              <option value="fail">‚úó</option>
            </select>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Immeral</div>
            <select id="save-result-3" class="input-field" style="padding: 0.25rem; font-size: 0.8rem;">
              <option value="pending">-</option>
              <option value="success">‚úì</option>
              <option value="fail">‚úó</option>
            </select>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.25rem;">Batula</div>
            <select id="save-result-4" class="input-field" style="padding: 0.25rem; font-size: 0.8rem;">
              <option value="pending">-</option>
              <option value="success">‚úì</option>
              <option value="fail">‚úó</option>
            </select>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #dc2626; margin-bottom: 0.25rem; font-weight: bold;">Tomb Builder</div>
            <select id="save-result-5" class="input-field" style="padding: 0.25rem; font-size: 0.8rem; border-color: #dc2626;">
              <option value="pending">-</option>
              <option value="success">‚úì</option>
              <option value="fail">‚úó</option>
            </select>
          </div>
        </div>
        <button class="action-btn activate" id="dicecam-update-save-btn" style="margin-top: 1rem;">Update Save Results</button>
      </div>
      
      <div id="dicecam-ready-controls" style="display: none;">
        <label class="text-sm text-gray-300 mt-3">Special Roll Result</label>
        <input type="number" id="dicecam-ready-result" class="input-field" placeholder="Enter roll result (e.g., 20 for nat 20)" value="">
        
        <button class="action-btn activate" id="dicecam-update-ready-btn" style="margin-top: 1rem;">Update Roll Result</button>
      </div>
      
      <div id="dicecam-roll-controls">
        <label class="text-sm text-gray-300 mt-3">Roll Result</label>
        <input type="number" id="dicecam-result" class="input-field" placeholder="Enter roll result (e.g., 15)" value="">
        
        <label class="text-sm text-gray-300">Modifier</label>
        <input type="number" id="dicecam-modifier" class="input-field" placeholder="Enter modifier (e.g., +3)" value="0">
        
        <button class="action-btn activate" id="dicecam-update-result-btn" style="margin-top: 1rem;">Update Roll Result</button>
      </div>
      
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button class="action-btn reset-action" id="dicecam-reset-btn" style="flex: 1;">Reset Dice Cam</button>
      </div>
    </div>

    <div class="status">
      <p id="status-message">Ready...</p>
      <p class="text-sm text-gray-400 mt-2">Selected: <span id="selected-char">None</span></p>
    </div>

    <div class="mt-6 p-4 bg-gray-800 rounded-lg">
      <h3 class="text-sm font-semibold mb-2 text-center text-gray-300">Keyboard Shortcuts</h3>
      <div class="grid grid-cols-2 gap-2 text-xs text-gray-400">
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Z</kbd> Zendith</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">T</kbd> Terra</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">F</kbd> Feathers</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">I</kbd> Immeral</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">B</kbd> Batula</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">W</kbd> Wild Shape Focus</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">D</kbd> Deactivate Wild Shape</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">E</kbd> Recover Wild Shape Use</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">R</kbd> Remove Stabilized</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">C</kbd> Clear Selection</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">K</kbd> Toggle Acererak/Player HP</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">A</kbd> Clear Acererak Action</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">M</kbd> Acererak Melee</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">O</kbd> Acererak Ranged</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">S</kbd> Acererak Skill</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">-</kbd> Damage (context-aware)</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">+</kbd> Heal (context-aware)</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Enter</kbd> Apply Damage</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Shift+Enter</kbd> Apply Heal</div>
        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Esc</kbd> Deselect</div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'hp-tracker-control';
    const ACERERAK_KEY = 'acererak-control';
    const DICECAM_KEY = 'dicecam-control';
    let selectedCharacter = null;
    let acererakHpDeducted = 0;
    let dicecamCurrentType = 'save';

    // Display current port in status message
    function updatePortDisplay() {
      const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
      const host = window.location.hostname;
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = `Ready. Running on ${host}:${port}`;
    }

    // Initialize port display on load
    updatePortDisplay();
    
    // Enumerate available cameras
    async function getCameraDevices() {
      try {
        // Request permission first
        await navigator.mediaDevices.getUserMedia({ video: true });
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        return videoDevices;
      } catch (err) {
        console.error('Error enumerating cameras:', err);
        showStatus('Camera permission required to list devices', 'error');
        return [];
      }
    }
    
    // Populate camera dropdown
    async function populateCameraList() {
      const select = document.getElementById('dicecam-source-select');
      select.innerHTML = '<option value="">Loading cameras...</option>';
      
      const cameras = await getCameraDevices();
      select.innerHTML = '';
      
      if (cameras.length === 0) {
        select.innerHTML = '<option value="">No cameras found</option>';
        return;
      }
      
      cameras.forEach((camera, index) => {
        const option = document.createElement('option');
        option.value = camera.deviceId;
        // Use label if available, otherwise use generic name
        option.textContent = camera.label || `Camera ${index + 1}`;
        select.appendChild(option);
      });
      
      showStatus(`Found ${cameras.length} camera(s)`, 'success');
    }
    
    // Initialize camera list on load
    populateCameraList();

    // Initialize Acererak HP display from localStorage if available
    const storedAcererakData = localStorage.getItem(ACERERAK_KEY);
    if (storedAcererakData) {
      try {
        const data = JSON.parse(storedAcererakData);
        // We'll track HP locally, but we can't retrieve it from commands
        // So we'll start fresh or you can add a separate storage key for state
      } catch (err) {
        console.error('Failed to parse Acererak data:', err);
      }
    }

    // Character buttons
    const characterBtns = document.querySelectorAll('.character-btn');
    characterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        characterBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedCharacter = parseInt(btn.dataset.index);
        document.getElementById('selected-char').textContent = btn.textContent;
      });
    });

    // HP Change buttons
    document.getElementById('damage-btn').addEventListener('click', () => {
      applyHPChange(-1 * parseInt(document.getElementById('hp-amount').value));
    });

    document.getElementById('heal-btn').addEventListener('click', () => {
      applyHPChange(parseInt(document.getElementById('hp-amount').value));
    });

    // Wild Shape buttons
    document.getElementById('activate-wild-shape').addEventListener('click', () => {
      const wildHP = parseInt(document.getElementById('wild-shape-hp').value);
      if (!wildHP || wildHP <= 0) {
        showStatus('Please enter a valid HP value', 'error');
        return;
      }
      sendCommand({
        type: 'wildShape',
        action: 'activate',
        maxHP: wildHP
      });
      showStatus(`Wild Shape activated with ${wildHP} HP`, 'success');
    });

    document.getElementById('deactivate-wild-shape').addEventListener('click', () => {
      sendCommand({
        type: 'wildShape',
        action: 'deactivate'
      });
      showStatus('Wild Shape deactivated', 'success');
    });

    function applyHPChange(change) {
      if (selectedCharacter === null) {
        showStatus('Please select a character first', 'error');
        return;
      }

      sendCommand({
        type: 'hpChange',
        characterIndex: selectedCharacter,
        change: change
      });

      showStatus(`Applied ${change > 0 ? '+' : ''}${change} HP to ${characterBtns[selectedCharacter].textContent}`, 'success');
    }

    function sendCommand(command) {
      // Store command in localStorage for the tracker to read
      const timestamp = Date.now();
      const commandWithTime = { ...command, timestamp };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(commandWithTime));
      
      // Also dispatch a storage event for same-origin communication
      window.dispatchEvent(new StorageEvent('storage', {
        key: STORAGE_KEY,
        newValue: JSON.stringify(commandWithTime),
        url: window.location.href,
        storageArea: localStorage
      }));
    }

    function sendAcererakCommand(command) {
      // Store command in localStorage for Acererak display to read
      const timestamp = Date.now();
      const commandWithTime = { ...command, timestamp };
      localStorage.setItem(ACERERAK_KEY, JSON.stringify(commandWithTime));
      
      // Update local HP counter
      if (command.type === 'hpChange') {
        acererakHpDeducted += command.change || 0;
        if (acererakHpDeducted < 0) {
          acererakHpDeducted = 0;
        }
        document.getElementById('acererak-hp-display').textContent = acererakHpDeducted;
      } else if (command.type === 'reset') {
        acererakHpDeducted = 0;
        document.getElementById('acererak-hp-display').textContent = acererakHpDeducted;
      }
      
      // Also dispatch a storage event for same-origin communication
      window.dispatchEvent(new StorageEvent('storage', {
        key: ACERERAK_KEY,
        newValue: JSON.stringify(commandWithTime),
        url: window.location.href,
        storageArea: localStorage
      }));
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : 'white';
      
      setTimeout(() => {
        updatePortDisplay();
        statusEl.style.color = 'white';
      }, 3000);
    }

    // Dice Cam functions
    function sendDiceCamCommand(command) {
      const commandWithTime = { ...command, timestamp: Date.now() };
      localStorage.setItem(DICECAM_KEY, JSON.stringify(commandWithTime));
      
      // Also dispatch a storage event for same-origin communication
      window.dispatchEvent(new StorageEvent('storage', {
        key: DICECAM_KEY,
        newValue: JSON.stringify(commandWithTime),
        url: window.location.href,
        storageArea: localStorage
      }));
    }

    function updateDiceCamType() {
      const type = document.getElementById('dicecam-type-select').value;
      dicecamCurrentType = type;
      
      // Show/hide controls based on type
      const saveControls = document.getElementById('dicecam-save-controls');
      const readyControls = document.getElementById('dicecam-ready-controls');
      const rollControls = document.getElementById('dicecam-roll-controls');
      
      if (type === 'ready') {
        saveControls.style.display = 'none';
        readyControls.style.display = 'block';
        rollControls.style.display = 'none';
        sendDiceCamCommand({ type: 'setType', rollType: type });
      } else if (type === 'save') {
        saveControls.style.display = 'block';
        readyControls.style.display = 'none';
        rollControls.style.display = 'none';
        // Send DC when switching to save type
        const dc = parseInt(document.getElementById('dicecam-dc').value) || 15;
        sendDiceCamCommand({ type: 'setType', rollType: type, dc: dc });
      } else {
        saveControls.style.display = 'none';
        readyControls.style.display = 'none';
        rollControls.style.display = 'block';
        sendDiceCamCommand({ type: 'setType', rollType: type });
      }
      
      showStatus(`Dice Cam: ${type.charAt(0).toUpperCase() + type.slice(1)} mode`, 'success');
    }

    function updateDiceCamSaveResults() {
      const dc = parseInt(document.getElementById('dicecam-dc').value) || 15;
      const results = [];
      for (let i = 0; i < 6; i++) {
        const result = document.getElementById(`save-result-${i}`).value;
        results.push(result);
      }
      sendDiceCamCommand({ type: 'setResult', rollType: 'save', saveResults: results, dc: dc });
      showStatus(`Dice Cam: Save results updated (DC ${dc})`, 'success');
    }

    function updateDiceCamReadyResult() {
      const result = document.getElementById('dicecam-ready-result').value;
      
      if (result === '' || result === null) {
        showStatus('Please enter a roll result', 'error');
        return;
      }
      
      sendDiceCamCommand({ 
        type: 'setResult', 
        rollType: 'ready',
        result: result
      });
      
      showStatus(`Dice Cam: Special Roll ${result}`, 'success');
    }

    function updateDiceCamRollResult() {
      const result = document.getElementById('dicecam-result').value;
      const modifier = parseInt(document.getElementById('dicecam-modifier').value) || 0;
      
      if (result === '' || result === null) {
        showStatus('Please enter a roll result', 'error');
        return;
      }
      
      sendDiceCamCommand({ 
        type: 'setResult', 
        rollType: dicecamCurrentType,
        result: result,
        modifier: modifier 
      });
      
      showStatus(`Dice Cam: Roll ${result} (${modifier >= 0 ? '+' : ''}${modifier})`, 'success');
    }

    function resetDiceCam() {
      sendDiceCamCommand({ type: 'reset' });
      document.getElementById('dicecam-type-select').value = 'ready';
      document.getElementById('dicecam-ready-result').value = '';
      document.getElementById('dicecam-result').value = '';
      document.getElementById('dicecam-modifier').value = '0';
      for (let i = 0; i < 5; i++) {
        document.getElementById(`save-result-${i}`).value = 'pending';
      }
      dicecamCurrentType = 'ready';
      updateDiceCamType();
      showStatus('Dice Cam: Reset', 'success');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      
      // Character selection by initials: Z, T, F, I, B
      if (key === 'z') {
        characterBtns[0].click(); // Zendith
      } else if (key === 't') {
        characterBtns[1].click(); // Terra
      } else if (key === 'f') {
        characterBtns[2].click(); // Feathers
      } else if (key === 'i') {
        characterBtns[3].click(); // Immeral
      } else if (key === 'b') {
        characterBtns[4].click(); // Batula
      } else if (key === 'w') {
        // Toggle between Wild Shape HP input and regular HP input
        const activeElement = document.activeElement;
        if (activeElement.id === 'wild-shape-hp') {
          document.getElementById('hp-amount').focus();
        } else {
          document.getElementById('wild-shape-hp').focus();
        }
      } else if (key === 'd') {
        // Deactivate Wild Shape
        document.getElementById('deactivate-wild-shape').click();
      } else if (key === 'e') {
        // Recover Wild Shape use
        sendCommand({
          type: 'recoverWildShape'
        });
        showStatus('Recovered Wild Shape use for Batula', 'success');
      } else if (key === 'r') {
        // Remove stabilized status from selected character
        if (selectedCharacter !== null) {
          sendCommand({
            type: 'removeStabilized',
            characterIndex: selectedCharacter
          });
          showStatus(`Removed stabilized status from ${characterBtns[selectedCharacter].textContent}`, 'success');
        }
      } else if (key === 'c') {
        // Clear character selection
        characterBtns.forEach(b => b.classList.remove('selected'));
        selectedCharacter = null;
        document.getElementById('selected-char').textContent = 'None';
      } else if (key === 'a') {
        // Clear Acererak action
        document.getElementById('acererak-clear-action-btn').click();
      } else if (key === 'k') {
        // Toggle between Acererak HP input and player HP input
        const activeElement = document.activeElement;
        if (activeElement.id === 'acererak-hp-amount') {
          document.getElementById('hp-amount').focus();
          document.getElementById('hp-amount').select();
        } else {
          document.getElementById('acererak-hp-amount').focus();
          document.getElementById('acererak-hp-amount').select();
        }
      } else if (key === 'm') {
        // Acererak Melee Attack
        document.getElementById('acererak-melee-btn').click();
      } else if (key === 'o') {
        // Acererak Ranged Attack
        document.getElementById('acererak-ranged-btn').click();
      } else if (key === 's') {
        // Acererak Skill
        document.getElementById('acererak-skill-btn').click();
      } else if (e.key === 'Enter') {
        // Apply HP change or activate wild shape based on focus
        const activeElement = document.activeElement;
        if (activeElement.id === 'wild-shape-hp') {
          document.getElementById('activate-wild-shape').click();
        } else if (activeElement.id === 'acererak-hp-amount') {
          // Shift+Enter for heal, Enter for damage on Acererak
          if (e.shiftKey) {
            document.getElementById('acererak-heal-btn').click();
          } else {
            document.getElementById('acererak-damage-btn').click();
          }
        } else if (activeElement.id === 'hp-amount') {
          // Default to damage if no specific button context
          document.getElementById('damage-btn').click();
        }
      } else if (e.key === '-' || e.key === '_') {
        const activeElement = document.activeElement;
        // Skip if focused on Dice Cam inputs
        if (activeElement.id === 'dicecam-result' || activeElement.id === 'dicecam-modifier') {
          return;
        }
        e.preventDefault(); // Prevent minus from appearing in input
        if (activeElement.id === 'acererak-hp-amount') {
          // Apply damage to Acererak
          document.getElementById('acererak-damage-btn').click();
        } else {
          // Apply damage to player character
          document.getElementById('damage-btn').click();
        }
      } else if (e.key === '+' || e.key === '=') {
        const activeElement = document.activeElement;
        // Skip if focused on Dice Cam inputs
        if (activeElement.id === 'dicecam-result' || activeElement.id === 'dicecam-modifier') {
          return;
        }
        e.preventDefault(); // Prevent plus from appearing in input
        if (activeElement.id === 'acererak-hp-amount') {
          // Apply heal to Acererak
          document.getElementById('acererak-heal-btn').click();
        } else {
          // Apply heal to player character
          document.getElementById('heal-btn').click();
        }
      } else if (e.key === 'Escape') {
        characterBtns.forEach(b => b.classList.remove('selected'));
        selectedCharacter = null;
        document.getElementById('selected-char').textContent = 'None';
      }
    });

    // Acererak Controls
    document.getElementById('acererak-activate-btn').addEventListener('click', () => {
      sendAcererakCommand({
        type: 'activate'
      });
      showStatus('Acererak: Activated (Tomb Builder Revealed)', 'success');
    });

    document.getElementById('acererak-deactivate-btn').addEventListener('click', () => {
      sendAcererakCommand({
        type: 'deactivate'
      });
      showStatus('Acererak: Deactivated (Poster Displayed)', 'success');
    });

    document.getElementById('acererak-damage-btn').addEventListener('click', () => {
      const damage = parseInt(document.getElementById('acererak-hp-amount').value);
      if (!damage || damage <= 0) {
        showStatus('Please enter a valid damage amount', 'error');
        return;
      }
      sendAcererakCommand({
        type: 'hpChange',
        change: damage
      });
      showStatus(`Dealt ${damage} damage to Acererak`, 'success');
    });

    document.getElementById('acererak-heal-btn').addEventListener('click', () => {
      const heal = parseInt(document.getElementById('acererak-hp-amount').value);
      if (!heal || heal <= 0) {
        showStatus('Please enter a valid heal amount', 'error');
        return;
      }
      sendAcererakCommand({
        type: 'hpChange',
        change: -heal // Negative value reduces HP deducted
      });
      showStatus(`Healed ${heal} HP for Acererak`, 'success');
    });

    document.getElementById('acererak-melee-btn').addEventListener('click', () => {
      sendAcererakCommand({
        type: 'action',
        action: 'melee'
      });
      showStatus('Acererak: Melee Attack', 'success');
    });

    document.getElementById('acererak-ranged-btn').addEventListener('click', () => {
      sendAcererakCommand({
        type: 'action',
        action: 'ranged'
      });
      showStatus('Acererak: Ranged Attack', 'success');
    });

    document.getElementById('acererak-skill-btn').addEventListener('click', () => {
      sendAcererakCommand({
        type: 'action',
        action: 'skill'
      });
      showStatus('Acererak: Skill Used', 'success');
    });

    document.getElementById('acererak-clear-action-btn').addEventListener('click', () => {
      sendAcererakCommand({
        type: 'clearAction'
      });
      showStatus('Acererak: Action cleared', 'success');
    });

    document.getElementById('acererak-reset-btn').addEventListener('click', () => {
      if (confirm('Reset Acererak HP to 0?')) {
        sendAcererakCommand({
          type: 'reset'
        });
        showStatus('Acererak HP reset', 'success');
      }
    });

    // Dice Cam Controls
    document.getElementById('dicecam-enable-btn').addEventListener('click', () => {
      sendDiceCamCommand({ type: 'enableCamera' });
      showStatus('Dice Cam: Camera enabled', 'success');
    });
    
    document.getElementById('dicecam-disable-btn').addEventListener('click', () => {
      sendDiceCamCommand({ type: 'disableCamera' });
      showStatus('Dice Cam: Camera disabled', 'success');
    });
    
    document.getElementById('dicecam-source-select').addEventListener('change', (e) => {
      const deviceId = e.target.value;
      const deviceName = e.target.options[e.target.selectedIndex].text;
      if (deviceId) {
        sendDiceCamCommand({ type: 'changeSource', deviceId: deviceId });
        showStatus(`Dice Cam: Switched to ${deviceName}`, 'success');
      }
    });
    
    document.getElementById('refresh-cameras-btn').addEventListener('click', () => {
      populateCameraList();
    });
    
    document.getElementById('dicecam-type-select').addEventListener('change', updateDiceCamType);
    
    document.getElementById('dicecam-update-save-btn').addEventListener('click', updateDiceCamSaveResults);
    
    document.getElementById('dicecam-update-ready-btn').addEventListener('click', updateDiceCamReadyResult);
    
    document.getElementById('dicecam-update-result-btn').addEventListener('click', updateDiceCamRollResult);
    
    document.getElementById('dicecam-reset-btn').addEventListener('click', resetDiceCam);
    
    // Initialize Dice Cam with default type
    updateDiceCamType();
  </script>
</body>
</html>
